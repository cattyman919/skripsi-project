#include "Helper.h"
#define USE_VL_MACRO
#include <windows.h> // For Windows-specific types, __stdcall, and often standard types
#include <cstdint>   // For uint32_t, uint64_t (C++ standard)
#include <cstdio>    // For printf (if you are using it, which the warning suggests)
// Potentially <iostream> if you use std::cout, etc.

#include "vxlib.h"

#ifndef _WIN64
#pragma comment(lib, "vxlib32.lib")
#else
#pragma comment(lib, "vxlib64.lib")
#endif

void decrypt(unsigned char* data, long dataLen, unsigned char* key, long keyLen, unsigned char* result) {
	VL_VIRTUALIZATION_BEGIN;
	unsigned char T[256];
	unsigned char S[256];
	unsigned char  tmp;
	int j = 0, t = 0, i = 0;


	for (int i = 0; i < 256; i++) {
		S[i] = i;
		T[i] = key[i % keyLen];
	}

	for (int i = 0; i < 256; i++) {
		j = (j + S[i] + T[i]) % 256;
		tmp = S[j];
		S[j] = S[i];
		S[i] = tmp;
	}
	j = 0;
	for (int x = 0; x < dataLen; x++) {
		i = (i + 1) % 256;
		j = (j + S[i]) % 256;

		tmp = S[j];
		S[j] = S[i];
		S[i] = tmp;

		t = (S[i] + S[j]) % 256;

		result[x] = data[x] ^ S[t];
	}
	VL_VIRTUALIZATION_END;
}

BOOL IsWow64(HANDLE pHandle)
{
	VL_VIRTUALIZATION_BEGIN;
	BOOL isWow64 = FALSE;

	typedef BOOL(WINAPI *PFNIsWow64Process) (HANDLE, PBOOL);
	PFNIsWow64Process _FNIsWow64Process;
	_FNIsWow64Process = (PFNIsWow64Process)GetProcAddress(GetModuleHandle(TEXT("kernel32")), "IsWow64Process");

	if (NULL != _FNIsWow64Process) {
		if (!_FNIsWow64Process(pHandle, &isWow64)) {}
	}
	return isWow64;
	VL_VIRTUALIZATION_END;
}